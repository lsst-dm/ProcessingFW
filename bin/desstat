#!/usr/bin/env python
# $Id$
# $Rev::                                  $:  # Revision of last commit.
# $LastChangedBy::                        $:  # Author of last commit.
# $LastChangedDate::                      $:  # Date of last commit.

import argparse
import sys

import processingfw.pfwcondor as pfwcondor
import processingfw.pfwdefs as pfwdefs


def main(argv=None):
    parser = argparse.ArgumentParser(description='desstat')
    parser.add_argument('--user', action='store', default=None)
    args = parser.parse_args(argv)

    constraint_str = "-constraint %sisjob " % pfwdefs.ATTRIB_PREFIX
    if args.user:
        constraint_str += args.user
    (qjobs, att_jobs, orphan_jobs) = pfwcondor.condorq_dag(constraint_str)

    jobcnt = len(qjobs)
    if jobcnt == 0:
        print "No framework jobs\n" 
        return(1)

    # Output jobs
    print_header()
    print_attempts(att_jobs, qjobs)
    print_orphans(orphan_jobs, qjobs)

    return(0)


######################################################################
def print_header(): 
    """ Print header line """
    print "%7s %1s %3s %-8s %-27s %-30s %-15s %-17s %-8s %-30s" % \
          ("ID", "T","PRJ","PIPELINE","RUN","BLOCK","SUBBLOCK","STAT (H/P/R/T)",
           "OPERATOR", "RUNSITE")
    print "="*133


######################################################################
def print_attempts(attids, qjobs):
    """ print attempt info """
    for topjobid in sorted(attids):
        info = pfwcondor.get_attempt_info(topjobid, qjobs)
        print_line(topjobid, " ", info)

######################################################################
def print_orphans(orphanids, qjobs):
    """ Print info for single orphan job """

    for topjobid in sorted(orphanids):
        info = pfwcondor.get_attempt_info(topjobid, qjobs)
        print_line(topjobid, "X", info)


######################################################################
def print_line(jid, jobtype, info):
    """ Print single line """
    print "%7s %1s %3s %-8s %-27s %-30s %-15s %-17s %-8s %-15s" % ( 
          jid, jobtype, info['project'][:3], info['pipeline'][:8],
          info['run'][:27], info['block'][:25], info['subblock'][:15], 
          info['status'][:17], info['operator'][:8], info['runsite'][:15]
    )


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
